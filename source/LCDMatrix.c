/*****************************************************************************
 * LcdMatrix.c
 *
 * functions for LCD matrix on eZ80 Development Board
 *****************************************************************************
 * Copyright (C) 2016 Hansjör Winterhalter  All Rights Reserved.
 *****************************************************************************/

#include <string.h>
#include <stdio.h>
#include <ez80.h>
#include "C:\Program Files (x86)\Zilog\ZDSII_eZ80Acclaim!_5.2.1\samples\Blase\include\LCDMatrix.h"
#include "C:\Program Files (x86)\Zilog\ZDSII_eZ80Acclaim!_5.2.1\samples\Blase\include\LCDTimer.h"
//#include "Z84C15.h"


/*  LCD matrix display pointer, what ever 5 byte string this points to will
 *  be displayed
 */
unsigned char *pcolumn;
unsigned char *p_user_input;
char user_input;


/*****************************************************************************
 *  lcdmatrix_init()
 *
 *  setup peripherals to use the LCD matix
 */
void lcdmatrix_init(void)
{
	/* clear display */
	lcdmatrix_clear();

	user_input = 0;
	p_user_input = &matrix_char_map[1][0];
}


/*****************************************************************************
 *  lcdmatrix_clear()
 *
 *  clear LCD matrix
 */
void lcdmatrix_clear(void)
{
	pcolumn = &matrix_char_map[1][0];
}


/*****************************************************************************
 *  lcdmatrix_fill()
 *
 *  fill LED matrix
 */
void lcdmatrix_fill(void)
{
	pcolumn = &matrix_char_map[0][0];
}


/*****************************************************************************
 *  lcdmatrix_putc(character)
 *
 *  ouput a character to the LCD Display
 */
void lcdmatrix_putc(char c)
{
	char index;
	/* Check if there is a user input */
	if (kbhit() == 1)
	{
		user_input = 1;
		c = getchar();
		p_user_input = &matrix_char_map[c - 31][0];
	}
	else
	{
		/* align ascii character to this programs character map */
    	index = c - 31;
		pcolumn = &matrix_char_map[index][0];
	}
}


/*****************************************************************************
 *  lcdmatrix_puts(string pointer)
 *
 *  ouput a character string to the LCD Matrix
 */
void lcdmatrix_puts(char *str)
{
	char *c;
	int i;

	c = str;

	for (i = 0; i < strlen(str); i++)
	{
	    /* place character */
        lcdmatrix_putc(*(str + i));
		wait(300);

	    /* briefly clear the display to cause a character change effect */
		lcdmatrix_clear();
        wait(50);
	}
}


/*****************************************************************************
 *  lcdmatrix_spin()
 *
 *  make display appear to spin
 */
void lcdmatrix_spin(void)
{
    int i;

  	for (i = 0; i < 15; i++)
	{
        lcdmatrix_putc('l');
		wait(60);

        lcdmatrix_putc('/');
		wait(60);

        lcdmatrix_putc('-');
		wait(60);

        lcdmatrix_putc('\\');
		wait(60);
    }
}


/*****************************************************************************
 *  lcdmatrix_flash()
 *
 *  This is a flashing display function
 */
void lcdmatrix_flash(void)
{
    int i;

  	for (i = 0; i < 2; i++)
	{
        lcdmatrix_fill();
		wait(200);

        lcdmatrix_clear();
		wait(200);
    }
}


/*****************************************************************************
 *  displays each character map entry
 *
 *  flash a bunch of data on the LCD Matrix
 */
void lcdmatrix_test(void)
{
    int i;

    /* run through the LCD matrix character map */
    for (i = 31; i < 129; i++)
	{
	    lcdmatrix_putc(i);
		wait(50);
    }
}


/*****************************************************************************
 *  128x128 LCD matrix character map
 *  this maps the column bit assignments (bits 0-4)
 */
const unsigned char matrix_char_map[128][7] = {
    /* misc. characters */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},  //  0 - block
    {0x1f, 0x1f, 0x1f, 0x1f, 0x1f, 0x1f, 0x1f},  //  1 - space
	{0x1b, 0x1b, 0x1b, 0x1b, 0x1b, 0x1f, 0x1b},  //  2 - !
    {0x15, 0x15, 0x15, 0x1f, 0x1f, 0x1f, 0x1f},  //  3 - "
	{0x1f, 0x15, 0x00, 0x15, 0x00, 0x15, 0x1f},  //  4 - #
	{0x1b, 0x11, 0x0a, 0x11, 0x0a, 0x11, 0x1b},  //  5 - $
	{0x1f, 0x1e, 0x15, 0x1b, 0x15, 0x0f, 0x1f},  //  6 - %
	{0x11, 0x0e, 0x0e, 0x11, 0x15, 0x0e, 0x10},  //  7 - &
	{0x1b, 0x1b, 0x1b, 0x1f, 0x1f, 0x1f, 0x1f},  //  8 - '
	{0x1d, 0x1b, 0x17, 0x17, 0x17, 0x1b, 0x1d},  //  9 - (
	{0x17, 0x1b, 0x1d, 0x1d, 0x1d, 0x1b, 0x17},  // 10 - )
	{0x1f, 0x0a, 0x11, 0x00, 0x11, 0x0a, 0x1f},  // 11 - *
	{0x1f, 0x1b, 0x1b, 0x00, 0x1b, 0x1b, 0x1f},  // 12 - +
	{0x1f, 0x1f, 0x1f, 0x1f, 0x1f, 0x1b, 0x17},  // 13 - ,
	{0x1f, 0x1f, 0x1f, 0x00, 0x1f, 0x1f, 0x1f},  // 14 - -
	{0x1f, 0x1f, 0x1f, 0x1f, 0x1f, 0x1f, 0x1b},  // 15 - .
	{0x1f, 0x1e, 0x1d, 0x1b, 0x17, 0x0f, 0x1f},  // 16 - /
    /* numbers */
    {0x11, 0x0e, 0x0c, 0x0a, 0x06, 0x0e, 0x11},  // 17 - 0
    {0x1b, 0x13, 0x1b, 0x1b, 0x1b, 0x1b, 0x11},  // 18 - 1
    {0x11, 0x0e, 0x1d, 0x1b, 0x17, 0x0f, 0x00},  // 19 - 2
    {0x11, 0x0e, 0x1e, 0x19, 0x1e, 0x0e, 0x11},  // 20 - 3
    {0x0e, 0x0e, 0x0e, 0x10, 0x1e, 0x1e, 0x1e},  // 21 - 4
    {0x00, 0x0f, 0x0f, 0x01, 0x1e, 0x0e, 0x11},  // 22 - 5
    {0x11, 0x0f, 0x0f, 0x01, 0x0e, 0x0e, 0x11},  // 23 - 6
    {0x00, 0x1e, 0x1e, 0x1d, 0x1b, 0x1b, 0x1b},  // 24 - 7
    {0x11, 0x0e, 0x0e, 0x11, 0x0e, 0x0e, 0x11},  // 25 - 8
    {0x11, 0x0e, 0x0e, 0x10, 0x1e, 0x1d, 0x1b},  // 26 - 9
    /* misc. characters */
    {0x1f, 0x1f, 0x1b, 0x1f, 0x1b, 0x1f, 0x1f},  // 27 - :
	{0x1f, 0x1f, 0x1b, 0x1f, 0x1b, 0x17, 0x1f},  // 28 - ;
	{0x1d, 0x1b, 0x17, 0x0f, 0x17, 0x1b, 0x1d},  // 29 - <
	{0x1f, 0x1f, 0x00, 0x1f, 0x00, 0x1f, 0x1f},  // 30 - =
	{0x17, 0x1b, 0x1d, 0x1e, 0x1d, 0x1b, 0x17},  // 31 - >
	{0x11, 0x0e, 0x0d, 0x1b, 0x1b, 0x1f, 0x1b},  // 32 - ?
	{0x11, 0x0a, 0x04, 0x04, 0x05, 0x0a, 0x11},  // 33 - @
    /* upper case characters */
    {0x11, 0x0e, 0x0e, 0x0e, 0x00, 0x0e, 0x0e},  // 34 - A
    {0x01, 0x0e, 0x0e, 0x01, 0x0e, 0x0e, 0x01},  // 35 - B
    {0x11, 0x0e, 0x0f, 0x0f, 0x0f, 0x0e, 0x11},  // 36 - C
    {0x01, 0x0e, 0x0e, 0x0e, 0x0e, 0x0e, 0x01},  // 37 - D
    {0x00, 0x0f, 0x0f, 0x01, 0x0f, 0x0f, 0x00},  // 38 - E
    {0x00, 0x0f, 0x0f, 0x01, 0x0f, 0x0f, 0x0f},  // 39 - F
    {0x11, 0x0e, 0x0f, 0x08, 0x0e, 0x0e, 0x11},  // 40 - G
    {0x0e, 0x0e, 0x0e, 0x00, 0x0e, 0x0e, 0x0e},  // 41 - H
    {0x00, 0x1b, 0x1b, 0x1b, 0x1b, 0x1b, 0x00},  // 42 - I
    {0x00, 0x1d, 0x1d, 0x1d, 0x0d, 0x0d, 0x13},  // 43 - J
    {0x0e, 0x0d, 0x0b, 0x07, 0x0b, 0x0d, 0x0e},  // 44 - K
    {0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x00},  // 45 - L
    {0x0e, 0x04, 0x0a, 0x0a, 0x0e, 0x0e, 0x0e},  // 46 - M
    {0x0e, 0x0e, 0x06, 0x0a, 0x0c, 0x0e, 0x0e},  // 47 - N
    {0x11, 0x0e, 0x0e, 0x0e, 0x0e, 0x0e, 0x11},  // 48 - O
    {0x01, 0x0e, 0x0e, 0x01, 0x0f, 0x0f, 0x0f},  // 49 - P
    {0x11, 0x0e, 0x0e, 0x0e, 0x0a, 0x0c, 0x10},  // 50 - Q
    {0x01, 0x0e, 0x0e, 0x01, 0x0b, 0x0d, 0x0e},  // 51 - R
    {0x11, 0x0e, 0x0f, 0x11, 0x1e, 0x0e, 0x11},  // 52 - S
    {0x00, 0x1b, 0x1b, 0x1b, 0x1b, 0x1b, 0x1b},  // 53 - T
    {0x0e, 0x0e, 0x0e, 0x0e, 0x0e, 0x0e, 0x11},  // 54 - U
    {0x0e, 0x0e, 0x0e, 0x0e, 0x0e, 0x15, 0x1b},  // 55 - V
    {0x0e, 0x0e, 0x0a, 0x0a, 0x0a, 0x0a, 0x15},  // 56 - W
    {0x0e, 0x0e, 0x15, 0x1b, 0x15, 0x0e, 0x0e},  // 57 - X
    {0x0e, 0x0e, 0x15, 0x1b, 0x1b, 0x1b, 0x1b},  // 58 - Y
    {0x00, 0x1e, 0x1d, 0x1b, 0x17, 0x0f, 0x00},  // 59 - Z
    /* misc. characters */
    {0x03, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x03},  // 60 - [
    {0x1f, 0x0f, 0x17, 0x1b, 0x1d, 0x1e, 0x1f},  // 61 - backslash
	{0x1c, 0x1e, 0x1e, 0x1e, 0x1e, 0x1e, 0x1c},  // 62 - ]
	{0x1b, 0x15, 0x0e, 0x1f, 0x1f, 0x1f, 0x1f},  // 63 - ^
	{0x1f, 0x1f, 0x1f, 0x1f, 0x1f, 0x1f, 0x00},  // 64 - _
	{0x1b, 0x1b, 0x1b, 0x1f, 0x1f, 0x1f, 0x1f},  // 65 - '
	/* lower case characters */
    {0x1f, 0x1f, 0x19, 0x16, 0x16, 0x16, 0x18},  // 66 - a
    {0x17, 0x17, 0x11, 0x16, 0x16, 0x16, 0x11},  // 67 - b
    {0x1f, 0x1f, 0x19, 0x16, 0x17, 0x16, 0x19},  // 68 - c
    {0x1e, 0x1e, 0x18, 0x16, 0x16, 0x16, 0x18},  // 69 - d
    {0x1f, 0x1f, 0x19, 0x10, 0x17, 0x16, 0x19},  // 70 - e
    {0x1d, 0x1a, 0x1b, 0x11, 0x1b, 0x1b, 0x1b},  // 71 - f
    {0x1f, 0x19, 0x16, 0x16, 0x18, 0x16, 0x19},  // 72 - g
    {0x17, 0x17, 0x11, 0x16, 0x16, 0x16, 0x16},  // 73 - h
    {0x1f, 0x1f, 0x1b, 0x1f, 0x1b, 0x1b, 0x1b},  // 74 - i
    {0x1f, 0x1d, 0x1f, 0x1d, 0x1d, 0x1d, 0x13},  // 75 - j
    {0x17, 0x17, 0x15, 0x13, 0x13, 0x15, 0x16},  // 76 - k
    {0x1b, 0x1b, 0x1b, 0x1b, 0x1b, 0x1b, 0x1b},  // 77 - l
    {0x1f, 0x1f, 0x05, 0x0a, 0x0a, 0x0a, 0x0a},  // 78 - m
    {0x1f, 0x1f, 0x11, 0x16, 0x16, 0x16, 0x16},  // 79 - n
    {0x1f, 0x1f, 0x19, 0x16, 0x16, 0x16, 0x19},  // 80 - o
    {0x1f, 0x11, 0x16, 0x16, 0x11, 0x17, 0x17},  // 81 - p
    {0x1f, 0x18, 0x16, 0x16, 0x18, 0x1e, 0x1e},  // 82 - q
    {0x1f, 0x1f, 0x11, 0x16, 0x17, 0x17, 0x17},  // 83 - r
    {0x1f, 0x1f, 0x18, 0x17, 0x19, 0x1e, 0x11},  // 84 - s
    {0x1f, 0x1f, 0x1b, 0x11, 0x1b, 0x1b, 0x1b},  // 85 - t
    {0x1f, 0x1f, 0x16, 0x16, 0x16, 0x16, 0x18},  // 86 - u
    {0x1f, 0x1f, 0x16, 0x16, 0x16, 0x16, 0x19},  // 87 - v
    {0x1f, 0x1f, 0x0a, 0x0a, 0x0a, 0x0a, 0x15},  // 88 - w
    {0x1f, 0x1f, 0x0e, 0x15, 0x1b, 0x15, 0x0e},  // 89 - x
    {0x1f, 0x1a, 0x1a, 0x1a, 0x1d, 0x1b, 0x17},  // 90 - y
    {0x1f, 0x1f, 0x10, 0x1d, 0x1b, 0x17, 0x10},  // 91 - z
    {0x1d, 0x1b, 0x1b, 0x17, 0x1b, 0x1b, 0x1d},  // 92 - {
	{0x1b, 0x1b, 0x1b, 0x1f, 0x1b, 0x1b, 0x1b},  // 93 - |
	{0x17, 0x1b, 0x1b, 0x1d, 0x1b, 0x1b, 0x17},  // 94 - }
	{0x1f, 0x1a, 0x15, 0x1f, 0x1f, 0x1f, 0x1f}   // 95 - ~
	};
